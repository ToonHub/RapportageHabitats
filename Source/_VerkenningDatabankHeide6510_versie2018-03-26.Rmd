#Heidehabitats en Habitattype 6510

## Overzicht opgemeten meetpunten

Tabel \@ref(tab:overzichtVoortgangHeide6510) geeft een overzicht van de bezochte en opgemeten meetpunten op basis van volgende kenmerken:

* Visited: plot al dan niet bezocht (afgeleid uit de gegevens in de databank)
* VisitedQC: plot al dan niet bezocht (afgeleid uit afzonderlijke boekhouding in kader van kwaliteitscontrole)
* Measured: plot opgemeten en gegevens ingevoerd
* Status van de plot

```{r voortgangHeide6510, results = 'hide', echo=FALSE, message=FALSE, warning = FALSE}

overzicht_Heide6510 <- getVisitedPlotsMHK(db = dbHeideEn6510_2018) %>%
  filter(Visited | VisitedQC == "ja")

overzicht <- overzicht_Heide6510 %>%
  group_by(Visited, VisitedQC, Measured, Status) %>%
  summarise(nPlots = n()) %>%
  arrange(Status)
  
```

```{r overzichtVoortgangHeide6510, echo=FALSE, message=FALSE, warning = FALSE}
overzicht %>%
kable(booktabs = T, format = "latex", caption = "Overzicht opgemeten meetpunten") %>%
  kable_styling(latex_options = c("hold_position"))
  
```


## Inlezen meetgegevens uit fieldmapdatabank

Voor de verkenning van de databank gebruiken we gegevens uit verschillende tabellen van de fieldmapdatabank.

* De tabel Standdiscription bevat gegevens over het geobserveerde habitat, in sommige gevallen opgesplitst in segmenten per plot.

* De tabellen SiteDiscriptionHeide en SiteDiscription6510 bevatten de variabelen opgemeten in de structuuplot.

* De tabel VegPQ geeft de bedekking van de vegetatielagen ingeschat in de vegetatieplot.

* De tabel Herblayer geeft de bedekking van alle aanwezige soorten in de kruidlaag in de vegetatieplot.

```{r dataInlezenHeide6510,  echo=FALSE, message=FALSE, warning = FALSE, results='hide'}



heide6510 <- c("4010", "4030", "2310", "6510_hu", "2330_bu",  "6510_hua", "6510_hus", "6510_huk", "6510", "2330")


```



## Verkenning databank

In Tabel \@ref(tab:missingDataTabelHeide6510) geven we een overzicht van ontbrekende gegevens van opgemeten punten. De aanwezigheid van volgende gegevens werd daarbij nagekeken:

* bedekking van vegetatielagen ('VeglayerMeasured')
* bedekking van aanwezige soorten ('VegspeciesMeasured')
* strutuurgegevens ('StructureMeasured')


```{r missingDataHeide6510, echo=FALSE, message=FALSE, warning = FALSE}

plotMeasure <- overzicht_Heide6510 %>%
  filter(Measured)

missingData <- plotMeasure %>%
  filter(!(VegspeciesMeasured  & VeglayerMeasured  & StructureMeasured) ) %>%
  select(IDPlots, VegspeciesMeasured, VeglayerMeasured, StructureMeasured) 
  
```

```{r missingDataTabelHeide6510, echo=FALSE, message=FALSE, warning = FALSE}

missingData %>%
  kable(booktabs = T, format = "latex", caption = "Ontbrekende data") %>%
  kable_styling(latex_options = c("hold_position"))

```


Tabel \@ref(tab:wrongHabcodeTabelHeide6510) geeft een overzicht van de plots waarvoor het geobserveerde habitat niet volledig werd gespecificeerd. We gaan er vanuit dat het habitat overeenkomt met het doelhabitat. Maar wat als er twee doelhabitats zijn?

```{r wrongHabcodeHeide6510,  echo=FALSE, message=FALSE, warning = FALSE}

heide6510_habsubt <- c("4010", "4030", "2310", "6510_hu", "2330_bu",  "6510_hua", "6510_hus", "6510_huk")


wrongHabCode <- plotMeasure %>%
  filter(! HabObserved %in% heide6510_habsubt) %>%
  select( IDPlots, HabObserved, HabTarget1, HabTarget2) 

plotMeasure <- plotMeasure %>%
  mutate(HabObserved = ifelse(! HabObserved %in% heide6510_habsubt, as.character(HabTarget1),
                              HabObserved))

```


```{r wrongHabcodeTabelHeide6510,  echo=FALSE, message=FALSE, warning = FALSE}
wrongHabCode %>%
  kable(booktabs = TRUE, format = "latex", caption = "Plots waarvoor habitatsubtype niet is gespecifieerd") %>%
   kable_styling(latex_options = c("hold_position"))

```


## Overzicht opgemeten meetpunten

Tabel \@ref(tab:MeasuredHabHeide6510) geeft een overzicht van de opgemeten punten per geobserveerd habitat(sub)type met onderscheid tussen binnen en buiten SBZH. De tabel geeft ook het gewenst aantal punten na 4 jaar (1/3de van de totale meetcyclus) en na 6 jaar.

```{r MeasuredHabHeide6510, results = 'asis', echo=FALSE, message=FALSE, warning = FALSE}

sampleSizeHeide6510 <- getSampleSize(habtypes = heide6510_habsubt) %>%
  mutate(nGewenst_4y = floor(nGewenst / 3),
         nGewenst_6y = floor(nGewenst / 2)) %>%
   select( HabObserved = habsubt, SBZH, nGewenst_4y, nGewenst_6y, Trefkans_verwacht)

overzicht_Observed_Year <-  plotMeasure %>%
  mutate(Year = format(as.Date(Date), "%Y")) %>%
  group_by( HabObserved, SBZH, Year) %>%
  summarise(n_Measured_Total = n()) %>%
  ungroup() %>%
  spread(key = Year, value = n_Measured_Total, fill = 0) %>%
  mutate(SBZH = ifelse(SBZH == 1, "Binnen", "Buiten"),
         TotalMeasured = `2014` + `2015` + `2016`) %>%
  left_join(select(sampleSizeHeide6510, -Trefkans_verwacht), by =c("HabObserved","SBZH")) %>%
  arrange(HabObserved, SBZH)

overzicht_Observed_Year %>%
kable(booktabs = T, format = "latex", caption = "Overzicht opgemeten punten en gewenst aantal opnames na 4 en 6 jaar") %>%
   kable_styling(latex_options = c("hold_position"))

```

## Overzicht trefkans

Tabel \@ref(tab:trefkansHeide6510) geeft een overzicht van de geobserveerde trefkans per habitat(sub)type. Trefkans_Target geeft de kans aan dat het doelhabitat wordt aangetroffen. Maar in sommige gevallen kan er ook een opname gebeuren als er een ander habitat dan het doelhabitat worden aangetroffen. Trefkans_Totaal geeft de verhouding tussen het totaal aantal opgemeten punten van een habitat(sub)type en het totaal aantal bezochte punten uit de steekproef voor dit habitat(sub)type.




```{r trefkansHeide6510,  echo=FALSE, message=FALSE, warning = FALSE}

overzicht_Heide6510_long <- overzicht_Heide6510 %>%
  filter(VisitedQC == "ja" & Visited) %>%
  gather(HabTarget1, HabTarget2, key = nHabTarget, value = HabTarget) %>%
  filter(!is.na(HabTarget))

overzicht_Target <-  overzicht_Heide6510_long %>%
  group_by( HabTarget, SBZH) %>%
  summarise(n_Visited = n(),
            n_Measured = sum(Measured),
            n_Measured_Target =  sum(HabTarget == HabObserved))

overzicht_Observed <-  plotMeasure %>%
  group_by(HabObserved, SBZH) %>%
  summarise(n_Measured_Total = n())

overzicht_trefkans <- full_join(rename(overzicht_Target, Hab = HabTarget), 
                                rename(overzicht_Observed, Hab = HabObserved), 
                                by = c("Hab", "SBZH")) %>%
  select(-n_Measured) %>%
  mutate(n_Measured_Total = ifelse(is.na(n_Measured_Total), 0, n_Measured_Total),
         Trefkans_Target = n_Measured_Target/ n_Visited,
         Trefkans_Total = n_Measured_Total/n_Visited)

overzicht_trefkans$Trefkans_Target <- round(overzicht_trefkans$Trefkans_Target,2)
overzicht_trefkans$Trefkans_Total <- round(overzicht_trefkans$Trefkans_Total,2)

overzicht_trefkans %>%
kable(booktabs = T, format = "latex", caption ="Overzicht trefkans") %>%
   kable_styling(latex_options = c("hold_position"))

```


```{r dataVerkenning3Heide6510, results = 'asis', echo=FALSE, message=FALSE, warning = FALSE}

#kable(addmargins(table(as.character(habMatch_measured$HabTarget1),as.character(habMatch_measured$HabObserved),dnn = c("a","b"))))

```





## Planning 2018-2019


```{r steekproefHeide, results = 'hide', echo=FALSE, message=FALSE, warning = FALSE}

sampleSizeHeide6510_join <- sampleSizeHeide6510 %>%
  select(Hab = HabObserved, SBZH, nGewenst_6y, Trefkans_verwacht) %>%
  mutate(SBZH = ifelse(SBZH == "Binnen", 1, 0))

nbPlotsToDo <- overzicht_Observed %>%
  ungroup() %>%
  select(Hab = HabObserved, SBZH, n_Measured_Total) %>%
  full_join(sampleSizeHeide6510_join , by = c("Hab", "SBZH")) %>%
  full_join(select(ungroup(overzicht_trefkans), Hab, SBZH, Trefkans_observed = Trefkans_Total), by = c("Hab", "SBZH"))

nbPlotsToDo[is.na(nbPlotsToDo)] <- 0

nbPlotsToDo$nOpnamesToDo_6y <- nbPlotsToDo$nGewenst_6y - nbPlotsToDo$n_Measured_Total

# voor heide gebruiken we geobserveerde trefkans als het aantal opgemeten punten groter is dan 5, anders gebruiken we de verwachte trefkans
#voor 6510 gebruiken we de verwachte trefkans (nieuw protocol moet trefkans doen verhogen) en stellen we een minimum trefkans van 0.6 in

nbPlotsToDo$Trefkans <- ifelse(substr(nbPlotsToDo$Hab,1,4) == "6510", pmax(nbPlotsToDo$Trefkans_verwacht, 0.6), ifelse(nbPlotsToDo$Trefkans_observed >0  & nbPlotsToDo$n_Measured_Total >= 5, nbPlotsToDo$Trefkans_observed, nbPlotsToDo$Trefkans_verwacht )) 

nbPlotsToDo$nBezoekenToDo_6y <- ceiling(nbPlotsToDo$nOpnamesToDo_6y/nbPlotsToDo$Trefkans)

# steekproef voor eerste drie jaar 

sampleHeide_3y <- getSample(fileSample = "meetnet_heide_versie20140611_orthocontrole")
sampleHeide_3y$Set <- "Set1"

sampleHeide_3y_OK <- sampleHeide_3y %>%
  filter(Orthocontr == 1) %>%
  mutate(IDPlots = as.numeric(as.character(IDPlots)))
  
sampleHeide_3y_Extra <- getSample(dirSampleHab = "../../Terrestrische habitats/Steekproef/Heide/.", fileSample = "steekproef_heide_extraBezoeken2016_versie20160511")
sampleHeide_3y_Extra$Set <- "Set2"


#nsteekproef jaar 4,5,6

sampleHeide_6y <- getSample(dirSampleHab = "../../Terrestrische habitats/Steekproef/Heide/.", fileSample = "meetnet_heide_versie20140611_SelectieJaar4_5_6")
sampleHeide_6y$Set <- "Set3"

sampleHeide_6y_overzicht <- sampleHeide_6y %>%
  group_by(SBZH, HabTarget1) %>%
  summarise(n = n())
  


overzicht_Heide6510_all <- getVisitedPlotsMHK(db = dbHeideEn6510_2018)

sampleHeide_bezoeken6y <- bind_rows(sampleHeide_3y_OK, sampleHeide_3y_Extra, sampleHeide_6y) %>%
  left_join(select(overzicht_Heide6510_all, IDPlots, Visited, VisitedQC))

heide_planning_tabel <- sampleHeide_bezoeken6y %>%
  group_by( HabTarget1, SBZH ) %>%
  summarise(n_planned = sum(!Visited),
            max_nb = max(nb)) %>%
  rename(Hab = HabTarget1) %>%
  left_join(select(nbPlotsToDo, Hab, SBZH, nOpnamesToDo_6y, Trefkans, nBezoekenToDo_6y), by = c("Hab", "SBZH")) %>%
  mutate(nToSelect = pmax(0, nBezoekenToDo_6y - n_planned)) %>%
  select(`Habitat(sub)type` = Hab, SBZH, nOpnameToDo = nOpnamesToDo_6y, Trefkans, nBezoekToDo = nBezoekenToDo_6y, nBezoekGepland = n_planned, nBezoekExtra = nToSelect)
 
```

###Heide

Tabel \@ref(tab:steekproefHeideTabel) geeft aan hoeveel punten er nog bezocht moeten worden ('nBezoekenToDo') om het gewenste aantal opnames te bekomen ('nOpnameToDo'). We gaan daarbij uit van de geobserveerde trefkans, tenzij het aantal opgemeten meetpunten kleiner is dan 5. Als dat het geval is, gebruiken we de verwachte trefkans. We kijken verder nog hoeveel bezoeken er nog gepland zijn en hoeveel bezoeken er dan nog extra moeten gebeuren in de periode 2018-2019. 

```{r steekproefHeideTabel, echo=FALSE, message=FALSE, warning = FALSE}

kable(heide_planning_tabel, booktab = TRUE, caption = "Aantal opnames en aantal bezoeken om het gewenste aantal opgmeten meetpunten te bekomen na 6 jaar", format = "latex") %>%
   kable_styling(latex_options = c("hold_position"))

```



```{r steekproefHeideShape, results = 'hide', echo=FALSE, message=FALSE, warning = FALSE}
# heide_shapefile <- readOGR("Data/Steekproef/.", "meetnet_heide_versie201400611")
# 
# heide_shapefile_df <- heide_shapefile@data
# 
# heide_shapefile_df <- filter(heide_shapefile_df, Orthocontr == 1, !Ranking %in% heide_planned$IDPlots)
# 
# heide_extra_ov <- summarise(group_by(heide_shapefile_df, habsubt, SBZH ),
#                             n =n())
# 
# heide_planned_ov <- full_join(heide_planned_ov, select(heide_extra_ov, Hab = habsubt, SBZH, nBeschikbaar = n))
# heide_planned_ov[is.na(heide_planned_ov)] <- 0
# 
# heide_planned_ov$nToSelectAv <- pmin(heide_planned_ov$nToSelect, heide_planned_ov$nBeschikbaar)
# 
# heide_shapefile_df <- left_join(heide_shapefile_df, select(heide_planned_ov, habsubt = Hab, SBZH, nToSelectAv), by = c("habsubt", "SBZH"))
# 
# heide_shapefile_df <- mutate(group_by(heide_shapefile_df, habsubt, SBZH),
#                              nb_stratum = rank(Ranking))
# 
# heide_shapefile_df$Select <- heide_shapefile_df$nb_stratum <= heide_shapefile_df$nToSelectAv
# 
# heide_select_df <- filter(heide_shapefile_df, Select)
# 
# nbPunten <- length(unique(heide_select_df$Ranking))
# 
# heide_select_shapefile <- heide_shapefile[heide_shapefile$ID %in% heide_select_df$ID,]
# 
# test <- heide_select_shapefile@data
# 
# #writeOGR(heide_select_shapefile, "Output/.", "meetnet_heide_versie20140611_SelectieJaar4_5_6", driver = "ESRI Shapefile")
# 
# heide_planned_ov$nTekort <- ifelse((heide_planned_ov$nBeschikbaar - heide_planned_ov$nToSelect) <0, heide_planned_ov$nToSelect - heide_planned_ov$nBeschikbaar, 0 )

```


```{r steekproefHeide2, results = 'asis', echo=FALSE, message=FALSE, warning = FALSE}

#pandoc.table(filter(select(heide_planned_ov, Hab, SBZH, nToSelect, nBeschikbaar, nTekort ), nTekort > 0), caption = "\\label{tab:Tekort} Strata waarvoor er onvoldoende meetpunten in de (totale) steekproef")

```

### Habitat 6510

```{r steekproef6510, results = 'hide', echo=FALSE, message=FALSE, warning = FALSE}

sample6510_6y <- getSample(dirSampleHab = "../../Terrestrische habitats/Steekproef/6510/.", fileSample = "meetnet_hab6510_versie20140506_SelectieJaar4_5_6")

maxRank <- sample6510_6y %>%
  group_by(HabTarget1, SBZH) %>%
  summarise(maxRankingPlanned = max(IDPlots)) %>%
  rename(HabTarget = HabTarget1)

# steekproef voor eerste drie jaar 

hab6510_planned_ov <- overzicht_Heide6510_all %>%
  gather(HabTarget1, HabTarget2, key = "nbHabTarget", value = "HabTarget") %>%
  filter(!is.na(HabTarget)) %>% 
   filter(substr(HabTarget,1,4) == "6510") %>%
  left_join(maxRank, by = c("HabTarget", "SBZH")) %>%
  mutate(PlannedQC = (VisitedQC == "nee"),
         Planned = (IDPlots <= maxRankingPlanned) & (VisitedQC == "nee" | is.na(VisitedQC)),
         Planned_4_6 = IDPlots %in% sample6510_6y$IDPlots) %>%
  group_by(HabTarget, SBZH) %>%
  summarise(n_planned = sum(Planned)) %>%
  rename(Hab = HabTarget) %>%
  left_join( select(nbPlotsToDo, Hab, SBZH, nOpnamesToDo_6y, Trefkans, nBezoekenToDo_6y), by = c("Hab", "SBZH")) %>%
  mutate(nToSelect = nBezoekenToDo_6y - n_planned) %>%
  select(`Habitat(sub)type` = Hab, SBZH, nOpnameToDo = nOpnamesToDo_6y, Trefkans, nBezoekToDo = nBezoekenToDo_6y, nBezoekGepland = n_planned)


```

Tabel \@ref(tab:steekproef6510Tabel) geeft aan hoeveel punten er nog bezocht moeten worden ('nBezoekenToDo') om het gewenste aantal opnames te bekomen ('nOpnameToDo'). We gaan daarbij uit van de verwachte trefkans (en dus niet de lagere geobserveerde trefkans). We gaan er ook van uit dat de trefkans minsten 0,6 bedraagt. We doen dit omdat het veldprotocol werd aangepast om de trefkans te verhogen. We kijken verder nog hoeveel bezoeken er nog gepland zijn in de periode 2018-2019. 

```{r steekproef6510Tabel, results = 'asis', echo=FALSE, message=FALSE, warning = FALSE}

kable(hab6510_planned_ov, caption = "Aantal opnames en aantal bezoeken om het gewenste aantal opgmeten meetpunten te bekomen na 6 jaar", booktabs = TRUE, format = "latex") %>%
   kable_styling(latex_options = c("hold_position"))

```


```{r steekproef6510Shape, results = 'hide', echo=FALSE, message=FALSE, warning = FALSE}
# hab6510_shapefile <- readOGR("Data/Steekproef/.", "steekproef_6510_versie20140506")
# 
# hab6510_shapefile_df <- hab6510_shapefile@data
# 
# hab6510_shapefile_df <- filter(hab6510_shapefile_df,!Ranking %in% habMatch_planned$IDPlots)
# 
# hab6510_extra_ov <- summarise(group_by(hab6510_shapefile_df, habsubt, SBZH ),
#                             n =n())
# 
# hab6510_planned_ov <- full_join(hab6510_planned_ov, select(hab6510_extra_ov, Hab = habsubt, SBZH, nBeschikbaar = n))
# hab6510_planned_ov[is.na(hab6510_planned_ov)] <- 0
# 
# hab6510_planned_ov$nToSelectAv <- pmin(hab6510_planned_ov$nToSelect, hab6510_planned_ov$nBeschikbaar)
# 
# hab6510_shapefile_df <- left_join(hab6510_shapefile_df, select(hab6510_planned_ov, habsubt = Hab, SBZH, nToSelectAv), by = c("habsubt", "SBZH"))
# 
# hab6510_shapefile_df <- mutate(group_by(hab6510_shapefile_df, habsubt, SBZH),
#                              nb_stratum = rank(Ranking))
# 
# hab6510_shapefile_df$Select <- hab6510_shapefile_df$nb_stratum <= hab6510_shapefile_df$nToSelectAv
# 
# hab6510_select_df <- filter(hab6510_shapefile_df, Select)
# 
# nbPunten <- length(unique(hab6510_select_df$Ranking))
# 
# hab6510_select_shapefile <- hab6510_shapefile[hab6510_shapefile$ID %in% hab6510_select_df$ID,]
# 
# test <- hab6510_select_shapefile@data
# 
# #writeOGR(hab6510_select_shapefile, "Output/.", "meetnet_hab6510_versie20140506_SelectieJaar4_5_6", driver = "ESRI Shapefile")
# 
# hab6510_planned_ov$nTekort <- ifelse((hab6510_planned_ov$nBeschikbaar - hab6510_planned_ov$nToSelect) <0, hab6510_planned_ov$nToSelect - hab6510_planned_ov$nBeschikbaar, 0 )

```


```{r Nazien, results = 'hide', echo=FALSE, message=FALSE, warning = FALSE}

# overzicht_3y <- summarise(group_by(sampleHeide_bezoeken3y, HabTarget1, SBZH),
#                           n_doorgegeven = n(),
#                           max_nb = max(nb),
#                           max_yearPlanned = max(Year))
# 
# measuredPlots <- select(habMatch_measured_unique, IDPlots , SBZH, x, y, JaarOpn = YearMeasured, HabObs = HabObserved, HabTarget1)
# 
# measuredPlots$ID <- factor(paste(measuredPlots$IDPlots, measuredPlots$HabTarget1, sep = "_"))
# 
# 
# #measuredPlots_Shape <- SpatialPointsDataFrame(coords=cbind(measuredPlots$x, measuredPlots$y),data = select(measuredPlots, HabObs))
# 
# 
# 
# 
# meetnetHeide <- readOGR("Data/Steekproef/.", "meetnet_heide_versie201400611")
# meetnet6510 <- readOGR("Data/Steekproef/.", "steekproef_6510_versie20140506")
# 
# 
# 
# meetnetHeide <- meetnetHeide[, "ID"]
# meetnet6510 <- meetnet6510[,"ID"]
# 
# meetnetHeide6510 <- rbind.SpatialPointsDataFrame(meetnetHeide, meetnet6510)
# 
# meetnetHeide6510 <- merge(meetnetHeide6510, measuredPlots, by = "ID", all.x = TRUE)
# 
# meetnetHeide6510 <- meetnetHeide6510[!is.na(meetnetHeide6510$JaarOpn), ]
# 
# test <- meetnetHeide6510@data
# 
# 
# writeOGR(meetnetHeide6510, dsn = "Output/.", layer =  "Habitatkwaliteitsmeetnet_heide6510_versie2017-04-12", driver = "ESRI Shapefile")
# 
# 
# sample_heide_shape <- readOGR("../Terrestrische habitats/Steekproef/Heide/.", "steekproef_heide_extraBezoeken2016_versie20160511")
# 
# test <- sample_heide_shape@data
# 
# writeOGR(sample_heide_shape, dsn = "Output/.", layer = "test", driver = "ESRI Shapefile")

```


