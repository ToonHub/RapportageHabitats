# Boshabitats

Voor de boshabitats maken we gebruik van meetpunten uit de bosinventarisatie en bijkomende meetpunten van het habitatkwaliteitsmeetnet.

## Data

```{r Bos outputFolder}
# analyseNaam <- paste("AnalyseBoshabitats", Sys.Date(), sep="_")
# setwd("../Output")
# dir.create(analyseNaam)
# 
# setwd(paste("../Output/", analyseNaam, sep =""))
# dir.create("InputRekenmodule")

analyseNaam <- "AnalyseBoshabitats_2018-11-20"

```  

### Ruwe Data

#### Bosinventarisatie

Een groot deel van de gegevens voor de boshabitats wordt via de de Bosinventarisatie ingezameld. De gegevens worden door ANB ingevoerd in Fieldmap. De gegevens worden vervolgens vanuit Fieldmap naar een Access-bestand geÃ«xporteerd en aangeleverd aan het INBO.

Dit Access-bestand bevat:

* Vegetatieopname in vegetatieplot
* Dendrometrische gegevens in cirkelplot
* Bestandsbeschrijving in cirkelplot

Het habitattype waarin elk meetpunt gelegen is, werd niet op terrein bepaald (dit zal wel in de toekomst gebeuren). Daarom maken we (1) een overlay tussen de meetpunten van de Bosinventarisatie en de Habitatkaart om te bepalen welke punten in boshabitat vallen, waarna we vervolgens (2) de punten selecteren die in een polygoon vallen met meer dan 50% van een bepaald boshabitattype. In een volgende fase kunnen we de selectie eventueel nog verder verfijnen op basis van meetgegevens van de bosinventarisatie (bestandstype, soortensamenstelling,...).

```{r Bos getDataHabtypes, cache = TRUE}

connectionStrata <- odbcConnectAccess2007(dbVBIStrata)

VBI_plots_N2000_2017 <- sqlFetch(connectionStrata,"tblN2000Habitat_versie2017-01-01" )
VBI_plots_N2000_2018 <- sqlFetch(connectionStrata,"tblN2000Habitat_versie2018-01-01" )

odbcClose(connectionStrata)

#test --> OK

VBI_plots_N2000_compare <- VBI_plots_N2000_2017 %>%
  left_join(VBI_plots_N2000_2018, by = "IDPlots") %>%
  select(IDPlots, starts_with("Pol"))

VBI_plots_N2000 <- VBI_plots_N2000_2018

```


```{r Bos overlayVBISBZH}
SBZH_shape <- readOGR("../../Basisdata/SBZH/.", "SBZH", verbose = FALSE)

```


```{r Bos selectieplots}

### Aanduiding van VBI-plots die al opgemeten werden in 2de cyclus

connectionMeetproces <- odbcConnectAccess2007(dbVBIMeetproces)

recordsVBI2 <- sqlFetch(connectionMeetproces, "tblRecordsVBI2+")
recordsVBI1 <- sqlFetch(connectionMeetproces, "tblRecordsVBI1")
plotCordinates <- sqlFetch(connectionMeetproces,"tblCoordinaten")
plotDetails <- sqlFetch(connectionMeetproces,"tblPlotDetails")
plotWeights <- sqlFetch(connectionMeetproces, "tblPlotWeights")

odbcClose(connectionMeetproces)

plotDetailsVBI2 <- plotDetails %>%
  filter(Periode == 2) %>%
  select(IDPlots, Reeks)

# selectie alle opnames uit VBI2 en de plots uit VBI die ook al in VBI2 werden opgemeten
plotDetailsVBI <- plotDetails %>%
  select(IDPlots, Periode, Reeks, DateDendro, DateVeg, Replaced, StartPeriode) %>%
  group_by(IDPlots) %>%
  mutate(nOpnames = n()) %>%
  ungroup() %>%
  filter(Periode == 2 | nOpnames == 2)

recordsVBI1$Periode <- 1

recordDetails <- recordsVBI2 %>%
  select(IDPlots, Periode, DendroRecord, VegRecord) %>%
  bind_rows(select(recordsVBI1, IDPlots, Periode, VegRecord, DendroRecord))

biogeo_regio <- readOGR("../Data/Shapefiles/.", "BioGeoregions_Lambert1972", verbose = FALSE)

VBI_plots_selection <- VBI_plots_N2000 %>%
  filter(Boshabitat) %>%
  filter(Phab >= 50) %>%
  left_join(plotDetailsVBI, by = "IDPlots") %>%
  left_join(recordDetails, by = c("IDPlots", "Periode")) %>%
  filter(!is.na(Reeks)) %>%
  filter(DendroRecord & VegRecord) %>%
  filter(!(Periode == 1 & Replaced))

#table(VBI_plots_selection$HabCode)
  
VBI_plots_selection_shape <- SpatialPointsDataFrame(coords = cbind(x = VBI_plots_selection$X_coord, y = VBI_plots_selection$Y_coord),
                                                    data = VBI_plots_selection)

proj4string(VBI_plots_selection_shape) <- proj4string(SBZH_shape)
VBI_plots_selection_shape$SBZH <- over(VBI_plots_selection_shape, SBZH_shape)$DEELGEBIED
VBI_plots_selection_shape$SBZH <- ifelse(is.na(VBI_plots_selection_shape$SBZH), 0, 1)

proj4string(VBI_plots_selection_shape) <- proj4string(biogeo_regio)
VBI_plots_selection_shape$Regio <- over(VBI_plots_selection_shape, biogeo_regio)$code

plotHabtypesVBI <- VBI_plots_selection_shape@data %>%
  mutate(HabCode = ifelse(HabCode == "91E0_vnva", "91E0_vn", as.character(HabCode)),
         HabCode = ifelse(HabCode == "9120_qb", "9120", as.character(HabCode)),
         HabCode = ifelse(HabCode == "9130_end", "9130", as.character(HabCode)),
         Meetnet = "VBI",
         IDSegments = 1) %>%
  left_join(select(plotWeights, IDPlots, Periode, IDSegments, PlotWeight, SegmentWeight), by = c("IDPlots", "IDSegments", "Periode")) %>%
  select(Meetnet, Periode, IDPlots, IDSegments, HabCode, Phab, SBZH, Regio, PlotWeight, SegmentWeight, X_coord, Y_coord)

data_habitat_VBI<- plotHabtypesVBI %>%
  mutate(ID = paste(Meetnet, IDPlots, "_", Periode, sep = ""),
         Habitattype = HabCode,
         PlotWeight = ifelse(is.na(PlotWeight), 1, PlotWeight),
         SegmentWeight = ifelse(is.na(SegmentWeight), 1, SegmentWeight),
         Weight = PlotWeight * SegmentWeight) %>%
  unique() %>%
  filter(HabCode != "91E0") %>% #subtype niet gespecifieerd in habitatkaart
  filter(HabCode != "91E0_sf") #VBI bevat onvoldoende gegevens voor LSVI-beoordeling 

```

#### Bijkomende meetpunten meetnet habitatkwaliteit

Deze gegevens worden eveneens ingezameld door ANB en aangeleverd aan INBO onder de vorm van een Access-bestand. De meetpunten worden op dezelfde manier opgemeten als in de bosinventarisatie. Bijkomend werd ook het habitattype per meetpunt bepaald.


```{r Bos bosTest, warning=FALSE}

#Data_habitat: check 155346 --> ok

overzicht_plots <- getVisitedPlotsBosMHK(db = dbBosExtra)

plotHabtypes_all <- overzicht_plots %>%
  filter(Measured == "ja") %>%
  #filter(IDSegments == 1) %>%
  select(IDPlots, IDSegments, HabCode= HabObserved) %>%
  mutate(HabCode = ifelse(HabCode == "91E0 vc", "91E0_vc", as.character(HabCode)),
         HabCode = ifelse(HabCode == "9130_end", "9130", as.character(HabCode)))

plotHabtypesMHK <- overzicht_plots %>%
  filter(Measured == "ja") %>%
  filter(IDSegments == 1) %>%
  mutate(X_coord = ifelse(is.na(X_m), X, X_m),
         Y_coord = ifelse(is.na(Y_m), Y, Y_m)) %>%
  select(IDPlots, IDSegments, SBZH, HabCode= HabObserved, Weight, X_coord, Y_coord) %>%
  mutate(HabCode = ifelse(HabCode == "91E0 vc", "91E0_vc", as.character(HabCode)),
         HabCode = ifelse(HabCode == "9130_end", "9130", as.character(HabCode)))

plotHabtypesMHK_shape <- SpatialPointsDataFrame(coords = cbind(x = plotHabtypesMHK$X_coord, y = plotHabtypesMHK$Y_coord), 
                                               data = plotHabtypesMHK)

proj4string(plotHabtypesMHK_shape) <- proj4string(biogeo_regio)

plotHabtypesMHK$Regio <- over(plotHabtypesMHK_shape, biogeo_regio)$code

data_habitat_bosExtra <- plotHabtypesMHK %>%
  mutate(Meetnet = "MHK",
         ID = paste(Meetnet, IDPlots, sep = ""),
         Habitattype = HabCode,
         Periode = 2) %>%
  unique() 

data_habitat_bos <- bind_rows(data_habitat_VBI, data_habitat_bosExtra) %>%
  mutate(SBZH = ifelse(SBZH == 1, "Binnen", "Buiten"),
         Weight = ifelse(is.na(Weight), 1, Weight))

```


### Meetpuntgewichten

Om onvertekende uitspraken te doen op een hoger schaalniveau, moeten we rekening houden met de meetpuntgewichten. We onderscheiden twee types gewichten:

* Plotgewichten: aandeel van de plot dat bedekt is door het habitat(sub)type (waarver we uitspraak doen).
* Stratumgewicht: de verschillende strata (binnen/buiten SBZH + habitatsubtypes) worden niet evenredig bemonsterd. Sommige strata kennen een grotere dichtheid aan meetpunten (bv. binnen SBZH omdat we daar een hogere precisie wensen).We moeten hiervoor compenseren als we een uitspraak op schaal Vlaanderen wensen. Per stratum kennen we daarom een gewicht toe aan de meetpunten gelijk aan de verhouding tussen de oppervlakte van dit stratum en het aantal meetpunten binnen dit stratum. Meetpunten in een stratum met een lagere dichtheid krijgen dus een groter gewicht.   

```{r Bos gewichten}

#update oppervlaktes habtypes op basis van BWK2018
habsubt_area <- read.csv2("../Data/Steekproef/BWK2018_Oppervlaktes.csv", stringsAsFactors = FALSE) %>%
  select(HabCode, Binnen, Buiten) %>%
  gather(Binnen, Buiten, key = SBZH, value = Area)

habtypes_gewicht <- data_habitat_bos %>%
  filter(Periode == 2) %>% #enkelhiervoor gewichten nodig
  group_by(HabCode, SBZH) %>%
  summarise (nPlots = n_distinct(ID)) %>%
  ungroup() %>%
  left_join(habsubt_area, by = c("SBZH", "HabCode")) %>%
  mutate(StratumWeight = Area/ nPlots,
         fps = round(Area * 10))

data_habitat_bos_weights <- data_habitat_bos %>%
  left_join(select(habtypes_gewicht, HabCode, SBZH, StratumWeight), by = c("HabCode", "SBZH")) %>%
  group_by(Habitattype) %>%
  mutate(StratumWeight_std = StratumWeight/ min(StratumWeight)) %>%
  ungroup() %>%
  mutate(WeightComb = Weight * StratumWeight_std)

plotHabtypes_continental <- data_habitat_bos %>%
  filter(Regio == "Continental")

data_habitat_bos <- data_habitat_bos_weights

```

## Overzicht meetpunten

Tabel \@ref(tab:BostabAantallen) geeft een overzicht van het aantal opgemeten meetpunten in de tweede bosinventarisatie en het meetnet habitatkwaliteit, en het totale steekproefgrootte die we na 12 jaar willen bereiken.

```{r BostabAantallen, message=FALSE, results='asis'}

data_habitat_bos_tbl <- data_habitat_bos %>%
  mutate(HabCode = ifelse(HabCode == "9130", "9130_end", HabCode))

steekproefgrootte <- getSampleSize(habtypes = data_habitat_bos_tbl$HabCode) %>%
  mutate(nGewenst = round(nGewenst, 0)) %>%
  select(habsubt, SBZH, nGewenst)
  
overzicht_Bos <- data_habitat_bos_tbl %>%
  filter(Periode == 2) %>%
  group_by(HabCode, SBZH, Meetnet) %>% 
  summarise(nOpgemeten = n_distinct(ID)) %>% 
  ungroup() %>% 
  #mutate(Meetnet = ifelse(is.na(Meetnet), "VBI2", Meetnet)) %>%
  spread(key = "Meetnet", value = "nOpgemeten", fill = 0) %>%
  full_join(steekproefgrootte, by = c("HabCode" = "habsubt", "SBZH")) %>%
  mutate(VBI = ifelse(is.na(VBI), 0, VBI),
         MHK = ifelse(is.na(MHK), 0, MHK),
         nGewenst = ifelse(is.na(nGewenst), 0, nGewenst),
         nOpgemetenTot = VBI + MHK) %>%
  select(HabCode, SBZH, "nOpgemeten VBI2" = VBI, "nOpgemeten MHK" = MHK, "nOpgemeten totaal" = nOpgemetenTot, nGewenst) %>%
  arrange(HabCode, SBZH)
  
kable(overzicht_Bos, format = "latex", caption = "Aantal opgemeten meetpunten in de 2de bosinventarisatie (VBI2) en in het meetnet habitatkwaliteit (MHK);en totaal aantal gewenste meetpunten na meetcyclus van 12 jaar", booktabs = T) 

```

Tabel \@ref(tab:BosTrends) geeft een overzicht van het aantal meetpunten die: 

* zowel in de eerste als in de tweede bosinventaristie werden opgemeten EN
* die niet werden verplaatst in de 1ste VBI EN
* waarvoor een dendrometrische opname en een vegetatieopname werd uigevoerd (in de 1ste VBI werd slechts in de helft van de meetpunten een vegetatieopname uitgevoerd).

```{r BosTrends, message=FALSE, results='asis'}

overzicht_Bos <- data_habitat_bos_tbl %>%
  filter(Periode == 1) %>%
  group_by(HabCode, SBZH, Meetnet) %>% 
  summarise(nOpgemeten = n_distinct(ID)) %>% 
  ungroup() %>% 
  #mutate(Meetnet = ifelse(is.na(Meetnet), "VBI2", Meetnet)) %>%
  spread(key = "Meetnet", value = "nOpgemeten", fill = 0) %>%
  full_join(steekproefgrootte, by = c("HabCode" = "habsubt", "SBZH")) %>%
  mutate(VBI = ifelse(is.na(VBI), 0, VBI),
         MHK = ifelse(is.na(MHK), 0, MHK),
         nGewenst = ifelse(is.na(nGewenst), 0, nGewenst),
         nOpgemetenTot = VBI + MHK) %>%
  select(HabCode, SBZH, "nOpgemeten VBI2" = VBI, "nOpgemeten MHK" = MHK, "nOpgemeten totaal" = nOpgemetenTot, nGewenst) %>%
  arrange(HabCode, SBZH)
  
kable(overzicht_Bos, format = "latex", caption = "Aantal meetpunten die zowel in de eerste als in de tweede bosinventarisatie werden opgemeten", booktabs = T) 

```


## Input voor LSVI-rekenmodule

We maken gebruik van de LSVI-rekenmodule. De rekenmodule vereist volgende input:

* data habitat: bevat het habitat(sub)type voor elke plot
* data voorwaarden: bevat de waarden voor de voorwaarden (elke indicator bestaat uit een of meerdere voorwaarden) die rechtstreeks op terrein worden opgemeten of die op voorhand berekend worden los van de rekenmodule
* data soorten en kenmerken: bevat de gegevens van de vegetatieopname en bepaalde kenmerken die opgemeten werden. Op basis hiervan berekent de rekenmodule de nog ontbrekende voorwaarden (die dus niet onder data voorwaarden werden ingevoerd)

Bij volgende variabelen worden de waarden rechtstreeks ingevoerd in de rekenmodule:

* aandeel dood hout
* hoeveelheid dik dood hout
* bosconstantie
* minimum structuurareaal (MSA)

'Aandeel dood hout' en 'hoeveelheid dik dood hout' worden berekend op basis van de dendrometrische gegevens (zowel staand als liggend dood hout). Beide variabelen worden steeds voor de volledige plot berekend, ook al bestaat het meetpunt slechts gedeeltelijk uit doelhabitat. 

De bosconstantie wordt afgeleid uit de bosleeftijdskaart en de bestandsleeftijd opgemeten op het terrein:

* bosconstantie >= 100 jaar als het meetpunt tot de klasse 'voor 1775' of 'tussen 1775 en 1850' behoort OF als de bestandsleeftijd > 100 jaar;
* bosconstantie >= 75 jaar als het meetpunt tot de klasse 'tussen 1850 en +-1930' behoort OF als de bestandsleeftijd > 80 jaar;
* bosconstantie >= 30 jaar als het meetpunt tot de klasse 'na +-1930' behoort  EN als de  bestandsleeftijd > 40 jaar heeft;
* bosconstantie < 30 jaar in alle andere gevallen.

MSA wordt afgeleid uit de kaart die VITO aangemaakt heeft.

De overige variabelen worden via de rekenmodule berekend op basis van volgende gegevens:

* bedekking soorten in de vegetatieplot;
* bedekking vegetatielagen in de vegetatieplot;
* aanwezige groeiklassen;
* grondvlak per boomsoort.

De aanwezige groeiklassen worden steeds voor de volledige plot bepaald, ook al bestaat het meetpunt slechts gedeeltelijk uit doelhabitat. Groeiklasse 1 (= open ruimte in bos) kan niet afgeleid worden uit de meetgegevens en ontbreekt dus steeds.

Voor het grondvlak per boomsoort rekenen we enkel de bomen mee binnen het deel van de plot dat uit doelhabitat bestaat. Op basis van deze variabele wordt immers het grondvlakaandeel van de sleutelsoorten in de boomlaag bepaald. Een uitzondering hierop is habitatsubtype 91E0_vc, dat vaak slechts over een kleine oppervlakte voorkomt en waarvoor ook de bomen in de omliggende habitatvlekken meegenomen moeten worden voor het bepalen van het aandeel sleutelsoorten. Ten slotte rekenen we bij habitattype 91E0  het grondvlak van populieren niet mee als de bedekking van de boomlaag zonder populier groter is dan 70 %. De bedekking van de boomlaag zonder populier leiden we af uit de vegetatieopname.

De variabele 'schaalgrootte ingrepen (ha)', die onderdeel uitmaakt van de indicator 'horizontale structuur - natuurlijke mozaiekstructuur', kan niet worden afgeleid uit de beschikbare gegevens en zal dus niet worden meegerekend bij de evaluatie van de LSVI.    

```{r Bos inputRekenmodule, warning=FALSE}

invoerBos <- geefInvoervereisten(Habitatgroep =  "Bossen en struwelen" , Kwaliteitsniveau = "1") %>%
  select(Habitatsubtype, Criterium, Indicator, Voorwaarde) %>%
  unique()

data_soortenKenmerkenVBI2 <- geefSoortenKenmerkenBosVBI2(db= dbVBI2, filter(data_habitat_VBI, Periode == "2"), databank = "VBI2")

data_soortenKenmerkenMHK <- geefSoortenKenmerkenBosVBI2(db = dbBosExtra, data_habitat_bosExtra, databank = "MHK") 

data_soortenKenmerkenVBI1 <- geefSoortenKenmerkenBosVBI1(dbDendro = dbVBI1, dbVeg = dbVBI1_veg, filter(data_habitat_VBI, Periode == "1"))

data_soortenKenmerken_bos <- bind_rows(data_soortenKenmerkenVBI2, data_soortenKenmerkenVBI1, data_soortenKenmerkenMHK) %>%
  select(-IDSegments)

bedekkingBoomlaagZonderPopulier <- data_soortenKenmerken_bos %>%
  filter(!is.na(Vegetatielaag) & Vegetatielaag %in% c("boomlaag", "struiklaag")) %>%
  filter(substr(Kenmerk,1,7) != "Populus" ) %>%
  group_by(ID) %>%
  summarise(BedekkingBL_zonderPopulier = (1 - prod(Waarde/100)) * 100) %>%
  ungroup()

data_habitat_VBI2_ander <- data_habitat_VBI %>%
  filter(HabCode != "91E0_vc") %>%
  filter(Periode == 2)

data_habitat_VBI2_91E0_vc <- data_habitat_VBI %>%
  filter(HabCode == "91E0_vc") %>%
  filter(Periode == 2)

data_habitat_VBI1_ander <- data_habitat_VBI %>%
  filter(HabCode != "91E0_vc") %>%
  filter(Periode == 1)

data_habitat_VBI1_91E0_vc <- data_habitat_VBI %>%
  filter(HabCode == "91E0_vc") %>%
  filter(Periode == 1)

data_habitat_bosExtra_ander <- data_habitat_bosExtra %>%
  filter(HabCode != "91E0_vc")

data_habitat_bosExtra_91E0_vc <- data_habitat_bosExtra %>%
  filter(HabCode == "91E0_vc")

#----

treesA3A4_2 <- getTreesA3A4VBI2()
shoots_2 <- getShootsVBI2()
test_2 <- calculateVolumeAndBasalArea(treesA3A4_2, shoots_2)
treesA3A4_1 <- getTreesA3A4VBI1()
shoots_1 <- getShootsVBI1()
test_1 <- calculateVolumeAndBasalAreaVBI1(treesA3A4_1, shoots_1)

test_12 <- bind_rows(test_1, test_2)

 query_tarieven2ing <-"
SELECT
  tblTariefgroepBoomsoort.ID
  , tblTariefgroepBoomsoort.Value
  , tblTarieven_2ing.Tarief
  , tblTarieven_2ing.groepNaam
  , tblTarieven_2ing.a
  , tblTarieven_2ing.b
  , tblTarieven_2ing.c
  , tblTarieven_2ing.d
  , tblTarieven_2ing.e
  , tblTarieven_2ing.f
  , tblTarieven_2ing.g
  , tblTarieven_2ing.Formule_type
  FROM tblTariefgroepBoomsoort
  INNER JOIN tblTarieven_2ing ON tblTariefgroepBoomsoort.TariefID = tblTarieven_2ing.groepID
  ;"

  query_tarieven1ing <-"
SELECT tblTariefgroepBoomsoort.ID
, tblTariefgroepBoomsoort.Value
, tblTariefgroepBoomsoort.TariefID
, tblTarieven_1ing.groepNaam
, tblTarieven_1ing.a
, tblTarieven_1ing.b
, tblTarieven_1ing.c
, tblTarieven_1ing.d
, tblTarieven_1ing.Tarief
FROM tblTariefgroepBoomsoort
LEFT JOIN tblTarieven_1ing ON tblTariefgroepBoomsoort.TariefID = tblTarieven_1ing.groepID
;"

  connectieExterneData <- odbcConnectAccess2007(dbVBIExterneData)
  tarieven2ingOrig <- sqlQuery(connectieExterneData, query_tarieven2ing, stringsAsFactors = TRUE)
  tarieven1ingOrig <- sqlQuery(connectieExterneData, query_tarieven1ing, stringsAsFactors = TRUE)
  odbcClose(connectieExterneData)

  tarieven2ing <- tarieven2ingOrig %>%
    rename(IDTreeSp = ID, Species = Value) 
  
  tarieven1ing <- tarieven1ingOrig %>%
    rename(IDTreeSp = ID, Species = Value)

  treesA3A4 <- getTreesA3A4VBI1()
  
  ### volume & grondvlak individuele bomen
  treesA3A4_levend <- treesA3A4 %>%
    filter(Alive | is.na(Alive)) %>%
    calcVolumeAndBasalAreaTree(tarieven2ing, 2)

  #dood hout heeft steeds als hoogte 0 in databank --> tarieven met 1 ingang
  treesA3A4_dood <- treesA3A4_1 %>%
    filter(!Alive & !is.na(Alive)) %>%
    calcVolumeAndBasalAreaTree(tarieven1ing, 1)

  treesA3A4 <- bind_rows(treesA3A4_levend, treesA3A4_dood) %>%
    mutate(Volume_ha = ifelse(Perimeter_cm < 122,
                              10000 * Volume / AreaA3_m2,
                              10000 * Volume / AreaA4_m2), #expansiefactoren --> volume per ha
           BasalArea_ha = ifelse(Perimeter_cm < 122, 
                                 10000 * BasalArea_m2/AreaA3_m2,
                                 10000 * BasalArea_m2/AreaA4_m2)) %>% #expansiefactoren -->  grondvlak per hectare
    arrange(IDPlots)

  shoots <- getShootsVBI1()
  ### volume & grondvlak per hakhoutstoof
  hakhout <- shoots %>%
    calcVolumeAndBasalAreaTree(tarieven1ing,1) %>%
    mutate(AreaA2_m2 = pi * 4.5 * 4.5,
           Volume_ha = 10000 * Volume / AreaA2_m2,
           BasalArea_ha = 10000 * BasalArea_m2 / AreaA2_m2) %>%
    group_by(IDPlots, ID, Alive) %>%
    summarise(Volume_ha = sum(Volume_ha, na.rm = TRUE),
              BasalArea_ha = sum(BasalArea_ha, na.rm = TRUE),
              Perimeter_cm = max(Perimeter_cm, na.rm =TRUE),
              IDTreeSp = unique(IDTreeSp)[1],
              NameNl = unique(NameNl)[1],
              NameSc = unique(NameSc)[1],
              ExoticSpecies = unique(ExoticSpecies)[1],
              InvasiveSpecies = unique(InvasiveSpecies)[1],
              Genus = unique(Genus)[1],
              Spec = unique(Spec)[1]) %>%
    ungroup() %>%
    mutate(DataSet = "VBI1",
           IDSegments = 1,
           Coppice_IndividualCode = 20,
           IntactTreeCode = 10,
           DBH_mm = Perimeter_cm/pi * 10)
    
  trees_all <- treesA3A4 %>%
    select(-AreaA4_m2, -AreaA3_m2, -BasalArea_m2,  -Volume, -TariefID) %>%
    bind_rows(hakhout)

  test <- getStandDiscriptionVBI1()
  
#-------  
  
#grondvlak op niveau segment (habitatvlek) behalve voor 91E0_vc
data_grondvlak_VBI2_ander <- berekenLevendHoutSoort(db = dbVBI2, plotIDs = data_habitat_VBI2_ander$IDPlots, niveau = "segment", databank = "VBI2") %>%
  filter(IDSegments == 1)

data_grondvlak_VBI2_91E0_vc <-  berekenLevendHoutSoort(db = dbVBI2, plotIDs = data_habitat_VBI2_91E0_vc$IDPlots, niveau = "plot", databank = "VBI2" )

data_grondvlak_bosExtra_ander <- berekenLevendHoutSoort(db = dbBosExtra, plotIDs = data_habitat_bosExtra_ander$IDPlots, niveau = "segment", databank = "MHK") %>%
  filter(IDSegments == 1)

data_grondvlak_bosExtra_91E0_vc <-  berekenLevendHoutSoort(db = dbBosExtra, plotIDs = data_habitat_bosExtra_91E0_vc$IDPlots, niveau = "plot", databank = "MHK")

data_grondvlak_VBI1_ander <- berekenLevendHoutSoort(db = dbVBI1, plotIDs = data_habitat_VBI1_ander$IDPlots, niveau = "segment", databank = "VBI1") %>%
  filter(IDSegments == 1)

data_grondvlak_VBI1_91E0_vc <-  berekenLevendHoutSoort(db = dbVBI1, plotIDs = data_habitat_VBI1_91E0_vc$IDPlots, niveau = "plot", databank = "VBI1" )

# populier mag verwijderd worden als de resterende bedekking van de boom- en struiklaag >=70%
# habtypes <- plotHabtypes %>%
#   select(ID = IDPlots, HabCode) %>%
#   mutate(ID = as.character(ID))

data_grondvlak_bos <- bind_rows(data_grondvlak_VBI1_ander,
                            data_grondvlak_VBI1_91E0_vc,
                            data_grondvlak_VBI2_ander,
                            data_grondvlak_VBI2_91E0_vc,
                            data_grondvlak_bosExtra_ander,
                            data_grondvlak_bosExtra_91E0_vc
                            ) %>%
  filter(!is.na(Kenmerk)) %>%
  left_join(bedekkingBoomlaagZonderPopulier, by = "ID") %>%
  left_join(select(data_habitat_bos, ID, HabCode), by = "ID") %>%
  mutate(Kenmerk = gsub(" species", "", Kenmerk),
         Kenmerk = gsub(" spec", "", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Quercus robur/petraea",
                          "Quercus robur",
                          ifelse(Kenmerk == "Betula tremula/alba",
                                 ifelse(HabCode %in% c("9110", "9120", "9130", "9160", "91E0_vo", "91E0_vm"), "Betula pendula", "Betula pubescens"), 
                                 ifelse(Kenmerk == "Lariks", 
                                        "Larix", Kenmerk))),
    VerwijderPopulier = (substr(Kenmerk,1,7) == "Populus") &
           (substr(HabCode,1,4) == "91E0") &
           ((!is.na(BedekkingBL_zonderPopulier)) & (BedekkingBL_zonderPopulier >= 70)))

data_grondvlak_bos_corr <- data_grondvlak_bos %>%
  filter(!VerwijderPopulier) %>%
  select(-HabCode, -BedekkingBL_zonderPopulier, -VerwijderPopulier)

data_soortenKenmerken_bos_all <- bind_rows(data_soortenKenmerken_bos,
                                   data_grondvlak_bos_corr) %>%
  mutate( Kenmerk = ifelse(Kenmerk == "Loofhout", "Quercus", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Naaldhout", "Pinus", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "F. excelsior/A. pseudoplatanus", "Fraxinus excelsior", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Picaea abies", "Picea abies", Kenmerk), #foute spelling
         Kenmerk = ifelse(Kenmerk == "Platanus hispanica L.", "Platanus", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Alnus x pubescens Tausch", "Alnus glutinosa x incana", Kenmerk), # soort niet herkend
          Kenmerk = ifelse(Kenmerk == "Salix x reichardtii A. Kerner", "Salix", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Taraxacum Wiggers sectie Subvulgaria Christians.", "Taraxacum Wiggers", Kenmerk),
         Kenmerk = ifelse(Kenmerk == "Populus x canadensis Moench", "Populus", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Rumex x pratensis Mert. et Koch", "Rumex", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Platanus x hispanica Mill. ex MÃ¼nchh.", "Platanus", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk == "Tilia x europaea L.", "Tilia", Kenmerk), # soort niet herkend
         Kenmerk = ifelse(Kenmerk %in% c("Cedrus atlantica (Endl.) Carr.", "Cedrus libani A. Rich.", "Sequoiadendron giganteum", "Sequoia", "Cupressus"), "Picea", Kenmerk)) %>% #exoten die niet herkend worden 
  arrange(ID)

# VBI2187065 --> kruidlaag = 0 maar wel soorten in de kruidlaag --> geeft Inf voor aandeel kruidlaag
# VBI2318028 --> geen kruidlaag --> geeft NA voor aandeel kruidlaag

#VBI2187065 --> onvolledige opname --> verwijderen
data_soortenKenmerken_bos_all <- data_soortenKenmerken_bos_all %>%
  filter(ID != "VBI2187065_2")

data_habitat_bos <- data_habitat_bos  %>%
  filter(ID != "VBI2187065_2")

#alles op plotniveau behalve natuurlijke mozaiekstructuur
data_vw_bosExtra <-  geefVoorwaardenBosVBI2(db = dbBosExtra, plotHabtypes =  data_habitat_bosExtra, niveau = "plot", databank = "MHK") 

data_vw_VBI <-  geefVoorwaardenBosVBI2(db = dbVBI2, plotHabtypes =  filter(data_habitat_VBI, periode == 2, niveau = "plot", databank = "VBI2") 

data_vw_bos <- bind_rows(data_vw_VBI, data_vw_bosExtra)

data_voorwaarden_bos <- data_vw_bos %>%
  inner_join(invoerBos, by = c("Habitatsubtype", "Voorwaarde")) %>%
  filter(ID != "VBI2187065") %>%
  filter(!is.na(Waarde))

#test
soorten <- data_soortenKenmerken_bos_all %>%
  filter(Eenheid == "Grondvlak_ha") %>%
  select( Kenmerk) %>%
  unique()

write.csv2(data_habitat_bos, paste("../Output/",
                                             analyseNaam,
                                             "/InputRekenmodule/data_habitat_bos.csv", sep = ""),
           row.names = FALSE)

write.csv2(data_soortenKenmerken_bos_all, paste("../Output/",
                                             analyseNaam,
                                             "/InputRekenmodule/data_soortenKenmerken_bos.csv", sep = ""),
           row.names = FALSE)

write.csv2(data_voorwaarden_bos, paste("../Output/",
                                             analyseNaam,
                                             "/InputRekenmodule/data_voorwaarden_bos.csv", sep = ""),
           row.names = FALSE)

```

## LSVI-berekening per meetpunt

Op basis van de LSVI-rekenmodule berekenen we de waarden voor de voorwaarden. Deze waarden worden afgetoetst aan de grenswaarden zodat we de status van elke voorwaarde krijgen. Vervolgens wordt de status per indicator bepaald. 


```{r Bos berekenLSVI, warning = TRUE, eval = FALSE}

soortnaamNietHerkend <- c("Populus x canadensis Moench", "Taraxacum Wiggers sectie Subvulgaria Christians.", "Alnus x pubescens Tausch", "Picaea abies", "Salix x reichardtii A. Kerner", "ANDERE SOORT", "Bamboe", "Rumex x pratensis Mert. et Koch", "Cedrus atlantica (Endl.) Carr.", "Platanus x hispanica Mill. ex MÃ¼nchh.", "Platanus hispanica L.", "Tilia x europaea L.", "Cedrus libani A. Rich." , "Sequoiadendron giganteum", "Sequoia", "Cupressus", "_ANDERE SOORT")

selectieNietHerkend <- data_soortenKenmerken_bos_all %>%
  filter(Kenmerk %in% soortnaamNietHerkend) %>%
  group_by(Kenmerk) %>%
  mutate(nObs = n()) %>%
  ungroup()

test <- geefSoortenlijst(Habitattype = "9120", Indicator = "invasieve exoten van de boom- en struiklaag", Versie = "Versie 3")

resultsLSVI <- berekenLSVIbasis(Kwaliteitsniveau = 1, 
                                           Data_voorwaarden = data_voorwaarden_bos,
                                           Data_soortenKenmerken = data_soortenKenmerken_bos_all,
                                           Data_habitat = data_habitat_bos ) 

resultsLSVI_vw <- resultsLSVI[[3]] %>%
    mutate(Habitatsubtype = Habitattype,
    Habitattype = substr(Habitattype, 1, 4)) %>%
   # WeightComb = Weight * StratumWeight) %>%
  select(Meetnet, ID, IDPlots, Habitattype, Habitatsubtype, Phab, Versie, Criterium, Indicator, Belang, Voorwaarde, Waarde, Operator, Referentiewaarde, Status_voorwaarde, VoorwaardeID, Combinatie, SBZH, Regio, PlotWeight = Weight, StratumWeight, WeightComb)

#checkNA
resultsLSVI_vw_NA <- resultsLSVI_vw %>%
  group_by(Voorwaarde) %>%
  summarise(sum(is.na(Waarde))) %>%
  ungroup()

# 1 plot zonder kruidlaag --> aandeel sleutelsoorten kruidlaag = 0 maken
# 7 plots zonder grondvlak --> aandeel sleutelsoorten boomlaag = 0 maken

resultsLSVI_vw <- resultsLSVI_vw %>%
  mutate(Waarde = ifelse(Voorwaarde %in% c("aandeel sleutelsoorten kruidlaag", "grondvlak sleutelsoorten boom- en struiklaag") & is.na(Waarde), "0", Waarde),
         Status_voorwaarde = ifelse(Voorwaarde %in% c("aandeel sleutelsoorten kruidlaag", "grondvlak sleutelsoorten boom- en struiklaag") & is.na(Status_voorwaarde), FALSE, Status_voorwaarde))

resultsLSVI_ind <- resultsLSVI[[2]] %>%
    mutate(Habitatsubtype = Habitattype,
    Habitattype = substr(Habitattype, 1, 4)) %>%
  left_join(select(data_habitat_bos, Meetnet, ID, IDPlots, Phab, SBZH, Regio, PlotWeight = Weight, StratumWeight, WeightComb), by = "ID") %>%
   # WeightComb = Weight * StratumWeight) %>%
  select(Meetnet, ID, IDPlots, Habitattype, Habitatsubtype, Phab, Versie, Criterium, Indicator, Belang, Status_indicator, SBZH, Regio, PlotWeight, StratumWeight, WeightComb)

#checkNA
resultsLSVI_ind_NA <- resultsLSVI_ind %>%
  group_by(Indicator) %>%
  summarise(sum(is.na(Status_indicator))) %>%
  ungroup()

resultsLSVI_ind <- resultsLSVI_ind %>%
  mutate(Status_indicator = ifelse(Indicator %in% c("sleutelsoorten kruidlaag", "sleutelsoorten boom- en struiklaag") & is.na(Status_indicator), FALSE, Status_indicator))

resultsLSVI_vw_exp <- resultsLSVI_vw %>%
  mutate(Waarde = gsub(".",  ",", Waarde, fixed = TRUE))

write.csv2(resultsLSVI_vw_exp, paste("../Output/", analyseNaam, "/Voorwaarden_bos.csv", sep =""), row.names = FALSE)

write.csv2(resultsLSVI_ind, paste("../Output/", analyseNaam, "/Indicatoren_bos.csv", sep =""), row.names = FALSE)

```

In een volgende stap bepalen we per meetpunt de status van de habitatvlek, rekening houdend met het belang van de indicatoren: de habitatvlek is gunstig als meer dan de helft van de indicatoren gunstig zijn EN geen enkele 'zeer belangrijke' indicator ongunstig is.

De indicator 'hoeveelheid dik dood' rekenen we niet mee bij het bepalen van de status van de habitatvlek. De waarde van deze indicator is niet precies genoeg om een uitspraak te doen op niveau van een individueel meetpunt. Wel is het mogelijk om de gemiddelde waarde van deze indicator te schatten op niveau Vlaanderen. 

```{r Bos statushabitatvlek}

resultsLSVI_ind <- read.csv2( paste("../Output/", analyseNaam, "/Indicatoren_bos.csv", sep =""), stringsAsFactors  = FALSE) %>%
  mutate(Habitattype = substr(Habitatsubtype, 1, 4))

# hoeveelheid dik dood houtnemen we niet mee in integratie habitatvlekniveau

statusHabitatvlek_bos <- resultsLSVI_ind %>% 
  filter(!is.na(Status_indicator)) %>%
  filter(Indicator != "hoeveelheid dik dood hout") %>%
  group_by(Meetnet, ID, IDPlots, Habitattype, Habitatsubtype, Phab, Versie, SBZH, Regio, PlotWeight, StratumWeight, WeightComb) %>%
  summarise(nGunstig = sum(Status_indicator),
            nIndicatoren = n(),
            n_zb_Ongunstig = sum(Status_indicator == FALSE & Belang == "zb"),
            AandeelGunstig = nGunstig/nIndicatoren * 100,
            Status_habitatvlek =  ifelse(n_zb_Ongunstig == 0 & AandeelGunstig > 50, 1, 0)) %>%
  ungroup()
  
write.csv2(statusHabitatvlek_bos, paste("../Output/", analyseNaam,"/StatusHabitatvlek_bos.csv", sep =""), row.names = FALSE)
```

## Uitspraak Vlaanderen en de Vlaams-Atlantische regio

Om tot een uitspraak te komen op schaal Vlaanderen (i.f.v. regionaal beleid) of de Vlaams-Atlantische regio (i.f.v. Europese rapportage), maken we een schatting van het aandeel habitat dat gunstig is en berekenen we bijhorende 95% betrouwbaarheidsinterval.

We maken een schatting:

* per habitattype,
* per habitatsubtype,
* per habitattype binnen SBZH,
* per habitattype buiten SBZH.

Voor habitattype 91E0 maken we ook gebruik van de resultaten van habitatsubtype 91E0_sf die werden bekomen op basis van de MONEOS-gegevens. We gebruiken daarvoor enkel de gegevens die in 2013 werden ingezameld. 

We schatten de betrouwbaarheidsintervallen op basis van een binomiaal model, zodat deze steeds tussen de 0 en 100% gelegen zijn. Om de meetpuntgewichten op een correcte wijze toe te passen in de analyse, maken we gebruik de R-package survey (Thomas Lumley, 2018).

```{r Bos statusVlaanderen}

analyseNaamMONEOS <- "AnalyseMONEOS_2018-11-19"

statusHabitatvlek_91E0_sf <- read.csv2( paste("../Output/", analyseNaamMONEOS, "/StatusHabitatvlek_MONEOS.csv", sep =""), stringsAsFactors  = FALSE) %>%
  mutate(Habitattype = substr(Habitatsubtype, 1, 4),
         Jaar = as.numeric(format(as.Date(Date, format = "%Y-%m-%d"),"%Y"))) %>%
  filter(Habitattype == "91E0" & Jaar == 2013) %>%
  select(-Date, -Jaar)

statusHabitatvlek_bos <- statusHabitatvlek_bos %>%
  mutate(IDPlots = as.character(IDPlots))

statusHabitatvlek_bos_91E0_sf <- bind_rows(statusHabitatvlek_91E0_sf, statusHabitatvlek_bos)


statusHabitat_bos_Vlaanderen <- habitatandeelGunstig(data = statusHabitatvlek_bos_91E0_sf, stratSBZH = FALSE) %>%
  mutate(Schaal = "Vlaanderen")

statusHabitat_bos_Vlaanderen_Atlantisch <- habitatandeelGunstig(data = filter(statusHabitatvlek_bos_91E0_sf, Regio == "Atlantic" ), stratSBZH = FALSE) %>%
  mutate(Schaal = "Vlaanderen Atlantisch")

statusHabitat_bos <-  bind_rows(statusHabitat_bos_Vlaanderen, statusHabitat_bos_Vlaanderen_Atlantisch) %>%
  select(Schaal, TypeResultaat, Versie, Habitattype, Habitatsubtype, SBZH, nObs, sumWeight = sumWeightsComb, AandeelGunstig, AandeelGunstig_LLCI, AandeelGunstig_ULCI) %>%
  arrange(Schaal, Habitattype, Versie,  TypeResultaat)

write.csv2(statusHabitat_bos, paste("../Output/", analyseNaam,"/StatusHabitat_bos.csv", sep =""), row.names = FALSE)
```

Op een analoge manier berekenen we ook afzonderlijk per indicator het aandeel habitat dat gunstig scoort voor de indicator in kwestie. 

```{r Bos statusIndicatorVlaanderen}

resultsLSVI_ind_91E0_sf <- read.csv2( paste("../Output/", analyseNaamMONEOS, "/Indicatoren_MONEOS.csv", sep =""), stringsAsFactors  = FALSE) %>%
  mutate(Habitattype = substr(Habitatsubtype, 1, 4),
         Jaar = as.numeric(format(as.Date(Date, format = "%Y-%m-%d"),"%Y"))) %>%
  filter(Habitattype == "91E0" & Jaar == 2013) %>%
  select(-Date, -Jaar)

resultsLSVI_ind <- resultsLSVI_ind %>%
  mutate(IDPlots = as.character(IDPlots))

resultsLSVI_ind <- bind_rows(resultsLSVI_ind_91E0_sf, resultsLSVI_ind)

overzicht_ind <- resultsLSVI_ind %>%
  select(Habitattype, Versie, Criterium, Indicator, Belang) %>%
  unique()

status_indicatoren_bos <- NULL

resultsLSVI_bos_notNA <- resultsLSVI_ind %>%
  filter(!is.na(Status_indicator))

for(habt in unique(resultsLSVI_bos_notNA$Habitattype)){ 
    
    data_habt <- resultsLSVI_bos_notNA %>%
    filter(Habitattype == habt)
  
      for(ind in unique(data_habt$Indicator)){
      
        data_ind <- data_habt %>%
          filter(Indicator == ind) %>%
          mutate(Status_habitatvlek = ifelse(Status_indicator, 1, 0))
        
        result_temp <- habitatandeelGunstig(data_ind, stratSBZH = FALSE) %>%
          mutate(Indicator = ind,
                 Schaal = "Vlaanderen") %>%
          left_join(overzicht_ind, by = c("Versie", "Habitattype", "Indicator")) %>%
          select(Schaal, TypeResultaat, Versie, Habitattype, Habitatsubtype, Criterium, Indicator, Belang, SBZH, nObs, sumWeight = sumWeightsComb, AandeelGunstig, AandeelGunstig_LLCI, AandeelGunstig_ULCI)
        
        status_indicatoren_bos <- bind_rows(status_indicatoren_bos, result_temp)
    
  }
}

write.csv2(status_indicatoren_bos, paste("../Output/", analyseNaam,"/Indicatoren_AandeelGunstigVlaanderen_bos.csv", sep =""), row.names = FALSE)


```

Voor de variabele 'hoeveelheid dik dood hout' berekenen we ook de gemiddelde waarde voor Vlaanderen.

```{r Bos gemiddeldeVoorwaarde, echo=FALSE}

resultsLSVI_vw <- read.csv2( paste("../Output/", analyseNaam, "/Voorwaarden_bos.csv", sep =""), stringsAsFactors  = FALSE) %>%
  mutate(Habitattype = substr(Habitatsubtype, 1, 4))

resultsLSVI_vw_91E0_sf <- read.csv2( paste("../Output/", analyseNaamMONEOS, "/Voorwaarden_MONEOS.csv", sep =""), stringsAsFactors  = FALSE) %>%
  mutate(Habitattype = substr(Habitatsubtype, 1, 4),
         Jaar = as.numeric(format(as.Date(Date, format = "%Y-%m-%d"),"%Y"))) %>%
  filter(Habitattype == "91E0" & Jaar == 2013) %>%
  select(-Date, -Jaar)

resultsLSVI_vw <- resultsLSVI_vw %>%
  mutate(IDPlots = as.character(IDPlots)) %>%
  bind_rows(resultsLSVI_vw_91E0_sf)

mean_vw_bos <- NULL

resultsLSVI_bos_notNA <- resultsLSVI_vw %>%
  filter(Voorwaarde %in% c("aantal exemplaren dik dood hout per ha")) %>%
  mutate(Waarde = as.numeric(Waarde)) %>%
  filter(!is.na(Waarde)) 

for(habt in unique(resultsLSVI_bos_notNA$Habitattype)){ 
    
    data_habt <- resultsLSVI_bos_notNA %>%
    filter(Habitattype == habt)
  
      for(vw in unique(data_habt$Voorwaarde)){
      
        data_vw <- data_habt %>%
          filter(Voorwaarde == vw) 
        
        result_temp <- habitatGemiddeldeVW(data_vw, stratSBZH = FALSE) %>%
          mutate(Voorwaarde = vw) %>%
          select(Versie, Habitattype, Habitatsubtype, Indicator, Voorwaarde, SBZH, nObs, sumWeight = sumWeightsComb, Gemiddelde, Gemiddelde_LLCI, Gemiddelde_ULCI)
        
        mean_vw_bos <- bind_rows(mean_vw_bos, result_temp)
    
  }
}

mean_doodhout_bos <- mean_vw_bos %>%
  filter(SBZH == "Binnen & Buiten") %>%
  select(-Versie) %>%
  unique()
  
write.csv2(mean_doodhout_bos, paste("../Output/", analyseNaam,"/DoodHoutVlaanderen_bos.csv", sep =""), row.names = FALSE)
```

